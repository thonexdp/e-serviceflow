name: Deploy to Cloud Run

on:
    push:
        branches:
            - staging

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: us-central1
    REPO_NAME: e-serviceflow-repo
    SERVICE_NAME: rcprintshoppe

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Google Auth
              uses: google-github-actions/auth@v1
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v1

            - name: Configure Docker
              run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

            # Build and Push App
            - name: Build and Push App Container
              run: |
                  docker build -f Dockerfile.app -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
                  docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}

            # Deploy App to Cloud Run
            - name: Deploy App to Cloud Run
              uses: google-github-actions/deploy-cloudrun@v1
              with:
                  service: ${{ env.SERVICE_NAME }}
                  image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
                  region: ${{ env.REGION }}
                  env_vars: |
                      APP_ENV=production
                      APP_DEBUG=true
                      APP_KEY=${{ secrets.APP_KEY }}
                      LOG_CHANNEL=stderr
                      DB_CONNECTION=mysql
                      DB_HOST=localhost
                      DB_SOCKET=/cloudsql/${{ secrets.DB_INSTANCE_CONNECTION_NAME }}
                      DB_DATABASE=${{ secrets.DB_DATABASE }}
                      DB_USERNAME=${{ secrets.DB_USERNAME }}
                      DB_PASSWORD=${{ secrets.DB_PASSWORD }}
                      BROADCAST_DRIVER=log
                      CACHE_DRIVER=file
                      QUEUE_CONNECTION=sync
                      SESSION_DRIVER=file
                  flags: |
                      --add-cloudsql-instances=${{ secrets.DB_INSTANCE_CONNECTION_NAME }}
                      --allow-unauthenticated
                      --memory=1Gi
